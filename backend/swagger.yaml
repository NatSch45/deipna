openapi: 3.0.3
info:
  title: Deipna API
  description: API de réservation de restaurants
  version: 1.0.0

servers:
  - url: http://localhost:8080
    description: Serveur de développement

tags:
  - name: Auth
    description: Authentification et gestion des utilisateurs
  - name: Restaurants
    description: Gestion des restaurants
  - name: Réservations
    description: Gestion des réservations

paths:
  /:
    get:
      summary: Accueil
      description: Endpoint de test
      responses:
        '200':
          description: Succès
          content:
            application/json:
              schema:
                type: object
                properties:
                  hello:
                    type: string
                    example: world

  /api/health:
    get:
      summary: Health check
      description: Vérifie que l'API est opérationnelle
      tags:
        - Auth
      responses:
        '200':
          description: API OK
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: ok

  /api/auth/register:
    post:
      summary: Inscription
      description: Créer un nouveau compte utilisateur
      tags:
        - Auth
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RegisterRequest'
      responses:
        '201':
          description: Compte créé avec succès
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthResponse'
        '409':
          description: Email déjà utilisé
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorMessage'

  /api/auth/login:
    post:
      summary: Connexion
      description: Authentifier et obtenir des tokens
      tags:
        - Auth
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/LoginRequest'
      responses:
        '200':
          description: Connexion réussie
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthResponse'
        '401':
          description: Identifiants invalides
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorMessage'

  /api/auth/refresh:
    post:
      summary: Rafraîchir le token
      description: Obtenir un nouveau token d'accès via le refresh token
      tags:
        - Auth
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RefreshTokenRequest'
      responses:
        '200':
          description: Nouveaux tokens générés
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthResponse'
        '401':
          description: Refresh token invalide ou expiré
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorMessage'

  /api/auth/me:
    get:
      summary: Profil utilisateur
      description: Récupérer les informations de l'utilisateur connecté
      tags:
        - Auth
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Profil utilisateur
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/User'
        '401':
          description: Non authentifié
        '404':
          description: Utilisateur non trouvé
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorMessage'

  /api/auth/logout:
    post:
      summary: Déconnexion
      description: Invalider les tokens de l'utilisateur
      tags:
        - Auth
      security:
        - bearerAuth: []
      responses:
        '204':
          description: Déconnexion réussie
        '401':
          description: Non authentifié

  /api/restaurants/search:
    get:
      summary: Rechercher des restaurants
      description: Recherche paginée de restaurants
      tags:
        - Restaurants
      parameters:
        - name: page
          in: query
          schema:
            type: integer
            minimum: 0
            default: 0
        - name: size
          in: query
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 20
        - name: query
          in: query
          description: Terme de recherche
          schema:
            type: string
      responses:
        '200':
          description: Liste paginée de restaurants
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RestaurantSearchResponse'

  /api/restaurants/{id}:
    get:
      summary: Détails d'un restaurant
      description: Récupérer les informations d'un restaurant par son ID
      tags:
        - Restaurants
      parameters:
        - $ref: '#/components/parameters/RestaurantId'
      responses:
        '200':
          description: Restaurant trouvé
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Restaurant'
        '404':
          description: Restaurant non trouvé
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorMessage'

    put:
      summary: Modifier un restaurant
      description: Mettre à jour un restaurant (authentification requise)
      tags:
        - Restaurants
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/RestaurantId'
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RestaurantUpdate'
      responses:
        '200':
          description: Restaurant mis à jour
        '401':
          description: Non authentifié
        '404':
          description: Restaurant non trouvé
        '501':
          description: Non implémenté

    delete:
      summary: Supprimer un restaurant
      description: Supprimer un restaurant (authentification requise)
      tags:
        - Restaurants
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/RestaurantId'
      responses:
        '204':
          description: Restaurant supprimé
        '401':
          description: Non authentifié
        '404':
          description: Restaurant non trouvé
        '501':
          description: Non implémenté

  /api/restaurants:
    post:
      summary: Créer un restaurant
      description: Créer un nouveau restaurant (authentification requise)
      tags:
        - Restaurants
      security:
        - bearerAuth: []
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RestaurantCreate'
      responses:
        '201':
          description: Restaurant créé
        '401':
          description: Non authentifié
        '501':
          description: Non implémenté

  /api/restaurants/{id}/available-slots:
    get:
      summary: Créneaux disponibles
      description: Récupérer les créneaux horaires disponibles pour une réservation
      tags:
        - Restaurants
      parameters:
        - $ref: '#/components/parameters/RestaurantId'
        - name: date
          in: query
          description: Date au format ISO (YYYY-MM-DD)
          required: true
          schema:
            type: string
            format: date
        - name: partySize
          in: query
          description: Nombre de personnes
          schema:
            type: integer
            minimum: 1
      responses:
        '200':
          description: Liste des créneaux disponibles
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/TimeSlot'
        '404':
          description: Restaurant non trouvé

  /api/restaurants/{id}/reservations:
    get:
      summary: Réservations du restaurant
      description: Liste des réservations d'un restaurant (authentification requise)
      tags:
        - Restaurants
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/RestaurantId'
      responses:
        '200':
          description: Liste des réservations
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Reservation'
        '401':
          description: Non authentifié
        '404':
          description: Restaurant non trouvé

  /api/reservations/my:
    get:
      summary: Mes réservations
      description: Liste des réservations de l'utilisateur connecté
      tags:
        - Réservations
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Liste des réservations
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Reservation'
        '401':
          description: Non authentifié

  /api/reservations/{id}:
    get:
      summary: Détails d'une réservation
      description: Récupérer les informations d'une réservation par son ID
      tags:
        - Réservations
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/ReservationId'
      responses:
        '200':
          description: Réservation trouvée
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Reservation'
        '401':
          description: Non authentifié
        '404':
          description: Réservation non trouvée
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorMessage'

    delete:
      summary: Annuler une réservation
      description: Annuler une réservation (authentification requise)
      tags:
        - Réservations
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/ReservationId'
      responses:
        '204':
          description: Réservation annulée
        '401':
          description: Non authentifié
        '404':
          description: Réservation non trouvée
        '501':
          description: Non implémenté

  /api/reservations:
    post:
      summary: Créer une réservation
      description: Réserver une table dans un restaurant
      tags:
        - Réservations
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ReservationCreate'
      responses:
        '201':
          description: Réservation créée
        '400':
          description: Données invalides
        '501':
          description: Non implémenté

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: Token JWT obtenu via /api/auth/login ou /api/auth/register

  parameters:
    RestaurantId:
      name: id
      in: path
      required: true
      description: ID du restaurant
      schema:
        type: string
        format: uuid
    ReservationId:
      name: id
      in: path
      required: true
      description: ID de la réservation
      schema:
        type: string
        format: uuid

  schemas:
    ErrorMessage:
      type: object
      properties:
        message:
          type: string
          description: Message d'erreur

    RegisterRequest:
      type: object
      required:
        - email
        - password
        - firstName
        - lastName
      properties:
        email:
          type: string
          format: email
        password:
          type: string
          minLength: 8
        firstName:
          type: string
          minLength: 1
        lastName:
          type: string
          minLength: 1
        phone:
          type: string
          nullable: true
        role:
          type: string
          enum: [CUSTOMER, RESTAURANT_OWNER, ADMIN]
          default: CUSTOMER

    LoginRequest:
      type: object
      required:
        - email
        - password
      properties:
        email:
          type: string
          format: email
        password:
          type: string

    RefreshTokenRequest:
      type: object
      required:
        - refreshToken
      properties:
        refreshToken:
          type: string

    AuthResponse:
      type: object
      properties:
        token:
          type: string
          description: Token JWT d'accès
        refreshToken:
          type: string
          description: Token de rafraîchissement
        user:
          $ref: '#/components/schemas/User'

    User:
      type: object
      properties:
        id:
          type: string
          format: uuid
        email:
          type: string
          format: email
        firstName:
          type: string
        lastName:
          type: string
        phone:
          type: string
          nullable: true
        role:
          type: string
          enum: [CUSTOMER, RESTAURANT_OWNER, ADMIN]
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time

    Restaurant:
      type: object
      properties:
        id:
          type: string
          format: uuid
        name:
          type: string
        description:
          type: string
        address:
          type: string
        phone:
          type: string
        capacity:
          type: integer
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time

    RestaurantCreate:
      type: object
      properties:
        name:
          type: string
        description:
          type: string
        address:
          type: string
        phone:
          type: string
        capacity:
          type: integer

    RestaurantUpdate:
      type: object
      properties:
        name:
          type: string
        description:
          type: string
        address:
          type: string
        phone:
          type: string
        capacity:
          type: integer

    RestaurantSearchResponse:
      type: object
      properties:
        content:
          type: array
          items:
            $ref: '#/components/schemas/Restaurant'
        totalElements:
          type: integer
        totalPages:
          type: integer
        page:
          type: integer
        size:
          type: integer

    TimeSlot:
      type: object
      properties:
        time:
          type: string
          format: time
          description: Heure au format HH:mm
        available:
          type: boolean

    Reservation:
      type: object
      properties:
        id:
          type: string
          format: uuid
        restaurantId:
          type: string
          format: uuid
        userId:
          type: string
          format: uuid
        date:
          type: string
          format: date
        time:
          type: string
          format: time
        partySize:
          type: integer
        status:
          type: string
          enum: [PENDING, CONFIRMED, CANCELLED]
        createdAt:
          type: string
          format: date-time

    ReservationCreate:
      type: object
      required:
        - restaurantId
        - date
        - time
        - partySize
      properties:
        restaurantId:
          type: string
          format: uuid
        date:
          type: string
          format: date
        description: Date au format YYYY-MM-DD
        time:
          type: string
          format: time
          description: Heure au format HH:mm
        partySize:
          type: integer
          minimum: 1
        notes:
          type: string
